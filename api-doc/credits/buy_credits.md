# Request Credits

Request credits by sending a **Zap Request** (NIP-57) to the admin's public key. This will return a Lightning Payment Request to complete the payment. The server will listen for the Zap Receipt (kind 9735) to confirm the payment and credit the user's account.

## Request
`POST /credits/request`

### Parameters

The request body must contain a valid NOSTR event of kind `9734` (Zap Request), signed by the user's `pubkey`.

### Example Request
```json
{
  "kind": 9734,
  "content": "",
  "tags": [
    ["relays", "NOSTR_RELAYS"],
    ["amount", "21000"],
    ["p", "ADMIN_PUBKEY"]
  ],
  "pubkey": "USER_PUBKEY",
  "sig": "VALID_SIGNATURE"
}
```

### Validation
The server will validate the following:
1. **Signature**: The event must be signed by the `pubkey` specified in the request.
2. **Zap Request Structure**:
   - The tag `["amount", "value"]` must be present, where `value` is the amount in millisatoshis (mSAT) to zap.
   - The tag `["p", "ADMIN_PUBKEY"]` must be included to ensure the zap is directed to the admin.

### Response
If the request is valid, the server will return a Lightning Payment Request for the specified amount.

#### Example Response
```json
{
    "paymentRequest": "lnbc21000n1p..."
}
```

### Credit Allocation
Once the Zap Receipt (kind `9735`) is detected:
1. The server verifies the receipt:
   - Confirms the payment was directed to `ADMIN_PUBKEY`.
   - Matches the `amount` in the receipt with the original Zap Request.
   - Ensures the sender's `pubkey` matches `USER_PUBKEY`.
2. Credits are added to the `USER_PUBKEY` account in the database:
   - The amount of credits is determined by a pre-defined conversion rate (e.g., `1 credit = 100 mSAT`).

## Admin Announcement of Remaining Credits

The `ADMIN_PUBKEY` will periodically announce the remaining credits for a user in the NOSTR network. This event provides transparency and allows users to check their credit balance.

#### Event Structure:

- **pubkey**: The `ADMIN_PUBKEY` (administrator's public key).
- **kind**: `31111`, indicating this event represents a credit balance announcement.
- **tags**:
  - `["p", "{USER_PUBKEY}"]`: Associates the event with the user's public key.
  - `["d", "credits:{USER_PUBKEY}"]`: Provides a deterministic identifier for the user's credit balance.
  - `["amount", "{CREDITS_BALANCE}"]`: Contains the current balance of the user in credits.
- **sig**: A valid signature generated by the `ADMIN_PUBKEY`.

#### Example:

```json
{
  "pubkey": "{ADMIN_PUBKEY}",
  "kind": 31111,
  "tags": [
    ["p", "{USER_PUBKEY}"],
    ["d", "credits:{USER_PUBKEY}"],
    ["amount", "{CREDITS_BALANCE}"]
  ],
  "sig": "{VALID_SIGNATURE}"
}
```

### Notes:
- This event serves as a broadcast mechanism for the administrator to announce the current credit balance of a specific user.
- The `amount` tag reflects the user's remaining credits.
- The `d` tag ensures that the event is uniquely tied to the user's public key for easy retrieval in the NOSTR ecosystem.

