# Request Credits

Request credits by sending a **Nostr Event** of kind `21111` to the server. The server will generate a **Zap Request** (NIP-57) directed to the admin's public key with the correct parameters and return a Lightning Payment Request. The server will listen for the Zap Receipt (kind `9735`) to confirm the payment and credit the user's account.

## Request
`POST /credits/request`

### Parameters

The request body must contain a valid Nostr event of kind `21111`, signed by the user's `pubkey`.

#### Example Request

```json
{
  "kind": 21111,
  "content": "",
  "tags": [
    ["t", "buy-credits"],
    ["amount", "10"]
  ],
  "pubkey": "USER_PUBKEY",
  "sig": "VALID_SIGNATURE"
}
```

### Validation

The server will validate the following:

1. **Signature**: The event must be signed by the `pubkey` specified in the request.
2. **Event Structure**:
   - The event must be of kind `21111`.
   - The tag `["t", "buy-credits"]` must be present.
   - The tag `["amount", "credits"]` must be present, where `credits` is the number of credits requested. The value must be at least `10`.

### Process

1. **Event Validation**:
   - The server validates the signature and structure of the event.

2. **Zap Request Generation**:
   - The server generates a Zap Request (kind `9734`) with the following details:
     - The `ADMIN_PUBKEY` as the recipient.
     - The amount in mSAT (`credits * 100`).
     - The relays to use (defined in `NOSTR_RELAYS`).
     - A reference to the user's `pubkey`.

3. **Lightning Payment Request**:
   - A Lightning Payment Request is created for the specified amount in mSAT.

4. **Response**:
   - The server returns the Lightning Payment Request to the user.

### Example Response

```json
{
  "success": true,
  "message": "lnbc10000n1p..."
}
```

### Credit Allocation

Once the Zap Receipt (kind `9735`) is detected:

1. The server verifies the receipt:
   - Confirms the payment was directed to `ADMIN_PUBKEY`.
   - Matches the `amount` in the receipt with the original Zap Request.
   - Ensures the sender's `pubkey` matches `USER_PUBKEY`.

2. Credits are added to the `USER_PUBKEY` account in the database:
   - The amount of credits is determined by a predefined conversion rate (`1 credit = 100 mSAT`).

## Admin Announcement of Remaining Credits

The `ADMIN_PUBKEY` will periodically announce the remaining credits for a user in the NOSTR network. This event provides transparency and allows users to check their credit balance.

#### Event Structure:

- **pubkey**: The `ADMIN_PUBKEY` (administrator's public key).
- **kind**: `31111`, indicating this event represents a credit balance announcement.
- **tags**:
  - `["p", "{USER_PUBKEY}"]`: Associates the event with the user's public key.
  - `["d", "credits:{USER_PUBKEY}"]`: Provides a deterministic identifier for the user's credit balance.
  - `["amount", "{CREDITS_BALANCE}"]`: Contains the current balance of the user in credits.
- **sig**: A valid signature generated by the `ADMIN_PUBKEY`.

#### Example:

```json
{
  "pubkey": "{ADMIN_PUBKEY}",
  "kind": 31111,
  "tags": [
    ["p", "{USER_PUBKEY}"],
    ["d", "credits:{USER_PUBKEY}"],
    ["amount", "{CREDITS_BALANCE}"]
  ],
  "sig": "{VALID_SIGNATURE}"
}
```

### Notes:

- **Conversion Rate**: 1 credit = 100 mSAT.
- **Validation**: Events are validated to ensure they follow the expected structure and tags.
- **Transparency**: Users can track their credit balance via announcements from the `ADMIN_PUBKEY`.
